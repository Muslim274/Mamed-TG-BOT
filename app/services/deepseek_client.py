"""
–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å DeepSeek API
app/services/deepseek_client.py
"""
import logging
import aiohttp
from typing import Optional, List, Dict

from app.config import settings

logger = logging.getLogger(__name__)

DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"


class DeepSeekClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å DeepSeek API"""
    
    def __init__(self):
        self.api_url = DEEPSEEK_API_URL
        self.api_key = settings.DEEPSEEK_API_KEY
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
    
    async def find_matching_answer(
        self, 
        user_question: str, 
        qa_pairs: List[Dict[str, str]]
    ) -> Optional[str]:
        """
        –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏–∑ –±–∞–∑—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç
        
        Args:
            user_question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            qa_pairs: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ 'question' –∏ 'answer'
        
        Returns:
            –û—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –∏–Ω–∞—á–µ None
        """
        if not qa_pairs:
            return None
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        questions_text = "\n".join([
            f"{i+1}. {qa['question']}" 
            for i, qa in enumerate(qa_pairs)
        ])
        
        system_prompt = """–¢—ã - —Å–∏—Å—Ç–µ–º–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –°–¢–†–û–ì–û:

1. –°—Ä–∞–≤–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –≤–æ–ø—Ä–æ—Å–æ–≤
2. –ï—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏—à—å –ü–û–•–û–ñ–ò–ô –≤–æ–ø—Ä–æ—Å (—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ —Å–º—ã—Å–ª—É –º–∏–Ω–∏–º—É–º 80%) - –æ—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –Ω–æ–º–µ—Ä–æ–º —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "3")
3. –ï—Å–ª–∏ –ù–ï –Ω–∞—Ö–æ–¥–∏—à—å –ø–æ—Ö–æ–∂–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 80% - –æ—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û —Å–ª–æ–≤–æ–º "–ù–ï–¢"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ù–ï –æ—Ç–≤–µ—á–∞–π –æ—Ç —Å–µ–±—è
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –æ—Ç–≤–µ—Ç—ã
- –¢–û–õ–¨–ö–û –Ω–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ —Å–ª–æ–≤–æ "–ù–ï–¢"
- –ò—â–∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 80% —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ —Å–º—ã—Å–ª—É
- –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è - –æ—Ç–≤–µ—á–∞–π "–ù–ï–¢"
- –ù–µ –ø—ã—Ç–∞–π—Å—è –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º - —Ç–æ–ª—å–∫–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–π –≤–æ–ø—Ä–æ—Å—ã"""

        user_prompt = f"""–°–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:
{questions_text}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_question}

–ï—Å—Ç—å –ª–∏ –≤–æ–ø—Ä–æ—Å –ø–æ—Ö–æ–∂–∏–π –º–∏–Ω–∏–º—É–º –Ω–∞ 80% –ø–æ —Å–º—ã—Å–ª—É? –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –Ω–æ–º–µ—Ä–æ–º –∏–ª–∏ —Å–ª–æ–≤–æ–º "–ù–ï–¢"."""

        try:
            async with aiohttp.ClientSession() as session:
                payload = {
                    "model": "deepseek-chat",
                    "messages": [
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_prompt}
                    ],
                    "temperature": 0,  # –°—Ç—Ä–æ–≥–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    "max_tokens": 10
                }
                
                async with session.post(
                    self.api_url, 
                    headers=self.headers, 
                    json=payload
                ) as response:
                    if response.status != 200:
                        logger.error(f"‚ùå DeepSeek API error: {response.status}")
                        return None
                    
                    data = await response.json()
                    ai_response = data['choices'][0]['message']['content'].strip()
                    
                    logger.info(f"ü§ñ DeepSeek response: {ai_response}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
                    if ai_response.upper() == "–ù–ï–¢":
                        return None
                    
                    # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –Ω–æ–º–µ—Ä
                    try:
                        question_number = int(ai_response) - 1  # -1 —Ç.–∫. –Ω—É–º–µ—Ä–∞—Ü–∏—è —Å 0
                        if 0 <= question_number < len(qa_pairs):
                            return qa_pairs[question_number]['answer']
                    except ValueError:
                        logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –Ω–æ–º–µ—Ä: {ai_response}")
                        return None
                    
                    return None
                    
        except Exception as e:
            logger.error(f"‚ùå Error calling DeepSeek API: {e}", exc_info=True)
            return None
    
    async def classify_message_type(self, user_message: str) -> str:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å
        
        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Returns:
            'greeting' - –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            'question' - –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å
        """
        system_prompt = """–¢—ã - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –°–¢–†–û–ì–û:

1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ß–ò–°–¢–´–ú –ü–†–ò–í–ï–¢–°–¢–í–ò–ï–ú –∏–ª–∏ –í–û–ü–†–û–°–û–ú
2. –û—Ç–≤–µ—Ç–∏—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º:
   - "greeting" - –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ –∫–æ—Ä–æ—Ç–∫–æ–µ —á–∏—Å—Ç–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ë–ï–ó –≤–æ–ø—Ä–æ—Å–æ–≤ (–ø—Ä–∏–≤–µ—Ç, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π, –¥–æ–±—Ä—ã–π –¥–µ–Ω—å, hi, hello –∏ —Ç.–¥.)
   - "question" - –í–°–Å –û–°–¢–ê–õ–¨–ù–û–ï (–ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è)

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û "greeting" –∏–ª–∏ "question"
- –ù–ï –æ—Ç–≤–µ—á–∞–π –æ—Ç —Å–µ–±—è
- –ù–ï –æ–±—ä—è—Å–Ω—è–π —Å–≤–æ–π –≤—ã–±–æ—Ä
- "–ü—Ä–∏–≤–µ—Ç" = greeting
- "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É?" = question (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –≤–æ–ø—Ä–æ—Å)
- "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" = greeting
- "–î–æ–±—Ä—ã–π –¥–µ–Ω—å, —É –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å" = question
- –õ—é–±–æ–π –≤–æ–ø—Ä–æ—Å, –¥–∞–∂–µ –≤–µ–∂–ª–∏–≤—ã–π = question
- –í –°–û–ú–ù–ï–ù–ò–Ø–• –≤—Å–µ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–π "question" """

        user_prompt = f"""–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}

–≠—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å? –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û "greeting" –∏–ª–∏ "question"."""

        try:
            async with aiohttp.ClientSession() as session:
                payload = {
                    "model": "deepseek-chat",
                    "messages": [
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_prompt}
                    ],
                    "temperature": 0,  # –°—Ç—Ä–æ–≥–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –±–µ–∑ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    "max_tokens": 10
                }
                
                async with session.post(
                    self.api_url, 
                    headers=self.headers, 
                    json=payload
                ) as response:
                    if response.status != 200:
                        logger.error(f"‚ùå DeepSeek API error: {response.status}")
                        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º question –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        return "question"
                    
                    data = await response.json()
                    ai_response = data['choices'][0]['message']['content'].strip().lower()
                    
                    logger.info(f"ü§ñ Message type classification: {ai_response}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
                    if "greeting" in ai_response:
                        return "greeting"
                    else:
                        return "question"
                    
        except Exception as e:
            logger.error(f"‚ùå Error classifying message: {e}", exc_info=True)
            # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –≤–æ–ø—Ä–æ—Å–æ–º
            return "question"
    
    async def generate_greeting_response(self, user_greeting: str, is_new_session: bool = True) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_greeting: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            is_new_session: True –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è (>12 —á–∞—Å–æ–≤), False –µ—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
        
        Returns:
            –ü–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        """
        if is_new_session:
            # –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è - –ø–æ–ª–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–º–æ—â–∏
            system_prompt = """–¢—ã - –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞:

1. –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¢–ê–ö–û–ú –ñ–ï —Å—Ç–∏–ª–µ –∏ –Ω–∞ –¢–ê–ö–û–ú –ñ–ï —è–∑—ã–∫–µ
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ—â–∏

–ü–†–ê–í–ò–õ–ê:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–ü—Ä–∏–≤–µ—Ç" - –æ—Ç–≤–µ—á–∞–π "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" - –æ—Ç–≤–µ—á–∞–π "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "Salam Aleykum" –∏–ª–∏ "–ê—Å—Å–∞–ª–∞–º—É –∞–ª–µ–π–∫—É–º" - –æ—Ç–≤–µ—á–∞–π "Aleykumu Salam! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "Hi" - –æ—Ç–≤–µ—á–∞–π "Hi! How can I help?"
- –í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–π –≤ —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ —á—Ç–æ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ üëã –≤ –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ö–û–†–û–¢–ö–ò–ú –∏ –î–†–£–ñ–ï–õ–Æ–ë–ù–´–ú
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?" –≤ –∫–æ–Ω—Ü–µ
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π"""
        else:
            # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ - –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –ë–ï–ó –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–º–æ—â–∏
            system_prompt = """–¢—ã - –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞:

1. –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¢–ê–ö–û–ú –ñ–ï —Å—Ç–∏–ª–µ –∏ –Ω–∞ –¢–ê–ö–û–ú –ñ–ï —è–∑—ã–∫–µ
2. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ—â–∏ (—ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞, –Ω–µ –Ω–∞—á–∞–ª–æ)

–ü–†–ê–í–ò–õ–ê:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–ü—Ä–∏–≤–µ—Ç" - –æ—Ç–≤–µ—á–∞–π –ø—Ä–æ—Å—Ç–æ "–ü—Ä–∏–≤–µ—Ç!"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" - –æ—Ç–≤–µ—á–∞–π –ø—Ä–æ—Å—Ç–æ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "Salam Aleykum" –∏–ª–∏ "–ê—Å—Å–∞–ª–∞–º—É –∞–ª–µ–π–∫—É–º" - –æ—Ç–≤–µ—á–∞–π "Aleykumu Salam!" –∏–ª–∏ –≤ –ø–æ–ª–Ω–æ–π —Ñ–æ—Ä–º–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª –ø–æ–ª–Ω—É—é
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –ø–æ–ª–Ω—É—é —Ñ–æ—Ä–º—É "Assalamu Aleykum Warahmatullahi Wabarakatuh" - –æ—Ç–≤–µ—á–∞–π –ø–æ–ª–Ω–æ–π —Ñ–æ—Ä–º–æ–π "Aleykumu Salam Warahmatullahi Wabarakatuh!"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "Hi" - –æ—Ç–≤–µ—á–∞–π –ø—Ä–æ—Å—Ç–æ "Hi!"
- –í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–π –≤ —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ —á—Ç–æ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ üëã –≤ –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –û–ß–ï–ù–¨ –ö–û–†–û–¢–ö–ò–ú
- –ù–ï –¥–æ–±–∞–≤–ª—è–π "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?" –∏–ª–∏ –¥—Ä—É–≥–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π"""

        user_prompt = f"""–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_greeting}

–û—Ç–≤–µ—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º:"""

        try:
            async with aiohttp.ClientSession() as session:
                payload = {
                    "model": "deepseek-chat",
                    "messages": [
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_prompt}
                    ],
                    "temperature": 0.3,
                    "max_tokens": 50
                }
                
                async with session.post(
                    self.api_url, 
                    headers=self.headers, 
                    json=payload
                ) as response:
                    if response.status != 200:
                        logger.error(f"‚ùå DeepSeek API error: {response.status}")
                        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–µ—Å—Å–∏–∏
                        if is_new_session:
                            return "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
                        else:
                            return "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"
                    
                    data = await response.json()
                    ai_response = data['choices'][0]['message']['content'].strip()
                    
                    logger.info(f"ü§ñ Generated greeting ({'new session' if is_new_session else 'continuation'}): {ai_response}")
                    
                    return ai_response
                    
        except Exception as e:
            logger.error(f"‚ùå Error generating greeting: {e}", exc_info=True)
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–µ—Å—Å–∏–∏
            if is_new_session:
                return "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
            else:
                return "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
deepseek_client = DeepSeekClient()